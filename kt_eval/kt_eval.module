<?php

/**
 * Imp of hook_menu
 */

function kt_eval_menu () {

  $items = array();

  $items['eval'] = array(
    'title' => t('Evaluations de formation Koumbit'),
    'access arguments' => array('access content'),
    'page callback' => 'kt_eval_formas',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['eval/%'] = array(
    'title' => t('Evaluations de la formation'),
    'description' => t('Oh yeah'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'page callback' => 'kt_eval_get_data',
    'page arguments' => array(1),
  );

  $items['eval/%/data'] = array(
    'title' => t('Evaluations de la formation'),
    'description' => t('Oh yeah'),
    'access arguments' => array('access content'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'page callback' => 'kt_eval_get_data',
    'page arguments' => array(1),
  );


  $items['eval/%/form'] = array(
    'title' => t('Evaluer la formation'),
    'description' => t('Oh yeah'),
    'access callback' => 'kt_eval_access_by_training',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'kt_eval_display_form',
    'page arguments' => array(1),
  );

  return $items;

}

/**
 * Listing of all available trainings
 */
function kt_eval_formas () {
  $result = db_query('SELECT name FROM {profile_fields} WHERE name LIKE "profile_forma_%"');
  $items = array();
  while ($row = db_fetch_object($result)) {
    $formatch = array();
    preg_match('/_[^_]+$/', $row->name, $formatch);
    $forma = substr($formatch[0], 1);
    $forma_link = l($forma, "eval/$forma");
    $items[] = $forma_link;
  }
  return theme('item_list', $items, NULL, 'ul');
}


/**
 * Access callback for evaluations
 *
 * @param $formation
 *   The training to check access for
 */
function kt_eval_access_by_training ($formation) {
  global $user;

  // php
  $pr_field = "profile_forma_$formation"; // profile_forma_php
  $fid = db_result(db_query('SELECT fid FROM {profile_fields} WHERE name = "%s"', $pr_field));
  if ($fid) {
    if (db_result(db_query('SELECT value FROM {profile_values} WHERE fid = %d AND uid = %d', $fid, $user->uid))) {
      return TRUE;
    }
    else {
      return FALSE;
    }
  }
  else {
    drupal_set_message(t("Your site admin must set !profilelink for this training before you can evaluate it.", array('!profilelink' => l('a profile field', 'admin/user/profile'))));
    return FALSE;
  }
}

/**
 * Page callback for eval/php
 *
 * @param $formation
 *   A string corresponding to the formation we want
 */
function kt_eval_get_data ($formation) {

  $result = db_query('DESCRIBE {kt_eval}');
  $data = array();
  while ($row = db_fetch_array($result)) {
   if ($row["Type"] == 'int(10) unsigned' && $row['Field'] != 'answer_id') { 
      $data[$row['Field']] = _kt_eval_get_average($row['Field'], $formation);
    }

    elseif ($row["Type"] == 'longtext') {
      $data[$row['Field']] = _kt_eval_get_text($row['Field'], $formation);
    }
  }
  return theme ('kt_eval_data', $data, 'kt_eval_form', $formation);
}

/**
 * Imp of hook_theme
 */
function kt_eval_theme () {
  return array(
    'kt_eval_data' => array(
      'arguments' => array('data' => array(), $form_id => 'kt_eval_form', $formation => NULL),
    ),
  );
}

/**
 * Theme the report of evaluation results
 *
 * @param $data array
 *   An associative array of column headers and their results
 * @param $form_id
 *   A form to construct to provide more human readable column names
 * @param $formation
 *   The name of the training
 */

function theme_kt_eval_data ($data = array(), $form_id, $formation) {
  $state = array();
  $form = drupal_retrieve_form($form_id, $state, $formation);
  $output = "<dl>\n";
  foreach ($data as $field => $value) {
    $category = explode('_', $field);
    $category = $category[0];
    $output .= "<dt>{$form[$category][$field]['#title']}</dt>\n";
    $output .= "<dd>$value</dd>\n";
  }
  $output .= '</dl>';

  return $output;
}

/**
 * Helper function to retrieve average of numerical evaluation fields
 *
 * @param $champ string
 *   The machine name of the field
 * @param $formation string
 *   The identifier of the training
 */
function _kt_eval_get_average($champ = 'apprentissage_q_1', $formation = 'php') {

  $result = db_query('SELECT AVG(%s) FROM {kt_eval} WHERE formation = "%s"', $champ, $formation);
  $output = db_result($result);
  return $output;
}

/**
 * Helper function to retrieve a concat of textual fields
 *
 * @param $champ string
 *   The machine name of the field
 * @param $formation string
 *   The identifier of the training
 */
function _kt_eval_get_text($champ = 'apprentissage_q_5', $formation = 'php') {

  $result = db_query('SELECT %s FROM {kt_eval} WHERE formation = "%s"', $champ, $formation);

  $items = array();
  while ($row = db_fetch_array($result)) {
    $items[] = $row[$champ];
  }

  return theme('item_list', $items, NULL, 'ul');
}


/**
 * Callback for the form page
 */
function kt_eval_display_form ($formation) {
  return drupal_get_form('kt_eval_form', $formation);
}

function kt_eval_form ($form_state, $formation) {
  global $user;

  $hashed_mail = md5($user->mail);
  $default_values = db_fetch_object(db_query('SELECT * FROM {kt_eval} WHERE repondeur = "%s"', $hashed_mail));

  $form = array();
    
  $echelle = array(
     1 => t("pas d'accord du tout"),
     2 => t("pas completement d'accord"),
     3 => t("d'accord"),
     4 => t("tout a fait d'accord"),
   ); 
   
  // Form 
  $form['#tree'] = FALSE;

  // Hidden

  $form['repondeur'] = array(
    '#type' => 'hidden',
    '#value' => $hashed_mail,
   );

  $form['formation'] = array(
    '#type' => 'hidden',
    '#value' => $formation,
   );

  $form['apprentissage'] = array(
    '#type' => 'fieldset',
    '#title' => t('Votre apprentissage'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE
  );

  //Question #1
  $form['apprentissage']['apprentissage_q_1']= array(
    '#type' => 'radios',
    '#title' => t("1- Je suis pret a me servir des outils et concepts dans cette formation"),
    '#options' => $echelle,
    '#default_value' => $default_values->apprentissage_q_1,
  );

  //Question #2
  $form['apprentissage']['apprentissage_q_2']= array(
    '#type' => 'radios',
    '#title' => t("2- La formation etait bien adaptee a mon rythme d'apprentissage"),
    '#options' => $echelle,
    '#default_value' => $default_values->apprentissage_q_2,
  );
  
  //Question #3
  $form['apprentissage']['apprentissage_q_3']= array(
    '#type' => 'radios',
    '#title' => t("3- J'ai pu pleinement participer aux exercices et discussions"),
    '#options' => $echelle,                           
    '#default_value' => $default_values->apprentissage_q_3,
  );

  //Question #4
  $form['apprentissage']['apprentissage_q_4']= array(
    '#type' => 'radios',
    '#title' => t("4- Je me suis sentie a l'aise dans cette formation"),
    '#options' => $echelle,                           
    '#default_value' => $default_values->apprentissage_q_4,
  );
    
  //Question #5
  $form['apprentissage']['apprentissage_q_5']= array(
    '#type' => 'textarea',
    '#title' => t("5- Qu'avez vous le plus apprecie dans cette formation?"),
    '#default_value' => $default_values->apprentissage_q_5,
  );

  //Question #6
  $form['apprentissage']['apprentissage_q_6']= array(
    '#type' => 'textarea',
    '#title' => t("6- Qu'avez vous le moins apprecie dans cette formation?"),
    '#default_value' => $default_values->apprentissage_q_6,
  );

  $form['formateur'] = array(
    '#type' => 'fieldset',
    '#title' => t('Formateur'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE
  );

  // Question #7
  $form['formateur']['formateur_q_1']= array(
    '#type' => 'radios',
    '#title' => t("7- J'avais confiance dans les competences du formateur"),
    '#options' => $echelle,                             
    '#default_value' => $default_values->formateur_q_1,
  );
    
  // Question #8
  $form['formateur']['formateur_q_2']= array(
    '#type' => 'radios',
    '#title' => t('8- Le formateur a ouvert suffisamment de temps aux questions et a la discussion'),
    '#options' => $echelle,                       
    '#default_value' => $default_values->formateur_q_2,
  );
   
  // Question #9
  $form['formateur']['formateur_q_3']= array(
    '#type' => 'radios',
    '#title' => t('9- Le formateur a su communiquer ses idees de maniere claire et comprehensible'),
    '#options' => $echelle,                           
    '#default_value' => $default_values->formateur_q_3,
  );

  // Question #10
  $form['formateur']['formateur_q_4']= array(
    '#type' => 'radios',
    '#title' => t('10- Les supports didactiques (documentation, references, graphiques) ont favorise mon apprentissage'),
    '#options' => $echelle,                           
    '#default_value' => $default_values->formateur_q_4,
  );


  // Question #11
  $form['formateur']['formateur_q_5']= array(
    '#type' => 'textarea',
    '#title' => t('11- Avez vous des suggestions pour le formateur?'),
    '#rows' => 5,                       
    '#default_value' => $default_values->formateur_q_5,
  );

  $form['prix'] = array(
    '#type' => 'fieldset',
    '#title' => t('Le prix'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE
  );

  // Question #12
  $form['prix']['prix_q_1'] = array(
    '#type' => 'radios',                                          
    '#title' => t("12 - Le prix de cette formation est abordable"),
    '#options' => $echelle,
    '#required' => FALSE,
    '#default_value' => $default_values->prix_q_1,
  );

  // Question #13
  $form['prix']['prix_q_2'] = array(
    '#type' => 'radios',                                          
    '#title' => t("13 - La formation vaut le prix"),
    '#options' => $echelle,
    '#required' => FALSE,
    '#default_value' => $default_values->prix_q_2,
  );

  $form['koumbit'] = array(
    '#type' => 'fieldset',
    '#title' => t('Koumbit à votre service'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE
  );

  // Question #14
  $form['koumbit']['koumbit_q_1'] = array(
      '#prefix' => t('Présentement, Koumbit offre plusieurs activités, dont des formations, des 5@7 thèmatiques, et bien sur nos assemblées générales. Nous bloguons régulièrement sur des sujets techniques et sociaux à travers !membres.', array(
      '!membres' => l('membres.koumbit.org', 'http://membres.koumbit.org'),
    )),
    '#type' => 'radios',                                          
    '#title' => t("14 - Je recommanderais cette formation a d'autres personnes"),
    '#options' => $echelle,
    '#required' => FALSE,
    '#default_value' => $default_values->koumbit_q_1,
  );

  // Question #15
  $form['koumbit']['koumbit_q_2'] = array(
    '#type' => 'radios',
    '#title' => t("15 - J'aimerais participer a de futures activites chez Koumbit"),
    '#options' => $echelle,
    '#required' => FALSE,
    '#default_value' => $default_values->koumbit_q_2,
  );

  // Question #16
  $form['koumbit']['koumbit_q_3'] = array(
    '#type' => 'radios',
    '#title' => t("16 - Je serais pret a venir partager mes connaissances lors d'ateliers ouverts"),
    '#options' => $echelle,
    '#required' => FALSE,
    '#default_value' => $default_values->koumbit_q_3
);

  // Question #17
  $form['koumbit']['koumbit_q_4'] = array(
    '#type' => 'textarea',
    '#title' => t("17 - Quelles seraient les activites que vous aimeriez que Koumbit organise"),
    '#required' => FALSE,
    '#default_value' => $default_values->koumbit_q_4
);

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );
   
  return $form;
}


/**
 * Submit handler for the evaluation form
 */
function kt_eval_form_submit ($form, $form_state) {
  $email_hash = $form_state[values]['repondeur'];
  $result = db_query('SELECT answer_id FROM {kt_eval} WHERE repondeur = "%s" AND formation = "%s" LIMIT 1', $email_hash, $form_state['values']['formation']);
  unset ($form_state['values']['submit']);
  if ($update_id = db_result($result)) {
    $form_state['values']['answer_id'] = $update_id;
    drupal_write_record('kt_eval', $form_state['values'], array('answer_id'));
  }
  else {
    drupal_write_record('kt_eval', $form_state['values']);
  }
  drupal_set_message (t('Thanks, your evaluation has been recorded.'));
}
